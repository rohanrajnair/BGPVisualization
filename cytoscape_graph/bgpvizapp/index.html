<!DOCTYPE html>

<html>
  <head>
    <title>BGP Graph Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="/popper.js"></script>
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <script>
    var ws = new WebSocket(
      "wss://ris-live.ripe.net/v1/ws/" //?client=js-example-1"
    );
    var params = {
      moreSpecific: true,
      host: "rrc21",
      socketOptions: {
        includeRaw: true,
      },
    };
    var msg_counter = 0;
    openSocket();

    function closeSocket() {
      ws.close();
    }
    function openSocket() {
      ws.onmessage = function (event) {
        var message = JSON.parse(event.data);
        var data = message.data;
        // console.log("type:" + data.type);
        // console.log("withdrawals:" + data.withdrawals);
        if (data.path) {
          addNode(cy, data);
        }
        if (msg_counter % 500 == 0) {
          var layout = cy.elements().layout({ name: "circle", animate: true });
          layout.run();
          updatePoppers(cy);
        }

        msg_counter++;
        document.getElementById(
          "msg_count"
        ).innerHTML = `Message count: ${msg_counter}`;
        // console.log(message.type, message.data);
      };
      ws.onopen = function () {
        ws.send(
          JSON.stringify({
            type: "ris_subscribe",
            data: params,
          })
        );
      };
    }
  </script>
  <style>
    #cy {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0px;
      left: 0px;
    }
  </style>

  <body>
    <h1>BGP Data Visualization</h1>
    <h2 id="msg_count"></h2>
    <button
      style="margin: 10px; padding: 10px; background-color: aquamarine"
      onclick="closeSocket();"
    >
      Close connection/Get summary stats
    </button>
    <div style="input: disabled" id="cy"></div>
    <script>
      function updatePoppers(cy) {
        cy.nodes().forEach((a) => {
          // let data = "AS " + a._private.data.color.substring(1);
          const asNum = a._private.data.id;
          let popper = a.popper({
            content: () => {
              let div = document.createElement("div");
              // div.innerHTML = `AS#${asNum}`;
              document.body.appendChild(div);
              return div;
            },
          });
          let update = () => {
            popper.update();
          };
          a.on("position", update);
          cy.on("pan zoom resize", update);
        });
      }
      //adds a node along with all its edges
      function addNode(cy, node_data) {
        const peer_asn = node_data.peer_asn;
        const path = node_data.path; //path of ASNs
        const main_node_obj = { id: peer_asn, color: "#90EE90" };
        if (cy.getElementById(peer_asn).length === 0) {
          cy.add({
            data: main_node_obj,
          });
        } else {
          if (node_data.withdrawals) {
            cy.getElementById(peer_asn).data("color", "#FF0000");
          } else {
            cy.getElementById(peer_asn).data("color", "#ADD8E6");
          }
        }
        for (let i = 1; i < path.length; i++) {
          const target_id = path[i];
          if (
            cy.getElementById(target_id).length > 0 &&
            cy.getElementById(`${peer_asn}_to_${target_id}`).length === 0
          ) {
            cy.add({
              data: {
                id: `${peer_asn}_to_${target_id}`,
                source: peer_asn,
                target: target_id,
              },
            });
          }
        }
        // var layout = cy.elements().layout({ name: "circle", animate: true });
        // layout.run();
      }
    </script>
    <script>
      function choose(choices) {
        var index = Math.floor(Math.random() * choices.length);
        return choices[index];
      }
      var cy = cytoscape({
        container: document.getElementById("cy"),
        elements: [],
        style: [
          {
            selector: "node",
            style: {
              // shape: "circle",
              "background-color": "data(color)",
              label: "data(id)",
            },
          },
        ],
      });
    </script>
  </body>
</html>
